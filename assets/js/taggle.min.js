(function(e){e.fn.taggle=function(t){var a={additionalTagClasses:"",allowDuplicates:!1,duplicateTagClass:"",containerFocusClass:"active",hiddenInputName:"taggles[]",tags:null,fontSize:11,tabIndex:1,placeholder:""},n=e.extend({},a,t);return this.each(function(){function t(){a(),l()}function a(){if(y.className="taggle_list",C.type="text",C.className="taggle_input",C.tabIndex=n.tabIndex,L.css("display","none").addClass("taggle_placeholder"),w.append(L),null!==n.tags)for(var e=0;n.tags.length>e;e++)y.innerHTML+='<li class="taggle '+n.additionalTagClasses+'">'+n.tags[e]+'<a href="javascript:void(0)" class="close">&times;</a>'+'<input type="hidden" value="'+n.tags[e]+'" name="'+n.hiddenInputName+'"></li>',b.push(n.tags[e].toLowerCase());n.placeholder&&(L.text(n.placeholder),n.tags.length||L.fadeIn("fast")),k.appendChild(C),y.appendChild(k),w.append(y)}function l(){w.on("click",function(){C.focus()}),C.onfocus=h,C.onblur=f,C.addEventListener?(C.addEventListener("keydown",p,!1),C.addEventListener("keyup",m,!1)):C.attachEvent&&(C.attachEvent("onkeydown",p),C.attachEvent("onkeyup",m)),w.find(".close").one("click",S)}function o(){c();var e=~~w.width(),t=~~w.find(".taggle_input").offset().left-~~w.offset().left,a=w.outerWidth()-e;c(e-t-a)}function i(t){var a=document.createElement("li"),l=document.createElement("a"),i=document.createElement("input"),s=t?t.toLowerCase():e.trim(C.value.toLowerCase());l.href="javascript:void(0)",l.innerHTML="&times;",l.className="close",l.onclick=S,a.innerHTML=s,a.className="taggle "+n.additionalTagClasses,i.type="hidden",i.value=s,n.hiddenInputName&&(i.name=n.hiddenInputName),b.push(s),a.appendChild(l),a.appendChild(i),e(y).find("li:last").before(a),e(a).find(".close:last").on("click",S),C.value="",c(),o()}function s(e){e=e||window.event;var t=w.find(".taggle:last"),a="hot";""===C.value&&8===e.keyCode?t.hasClass(a)?(r(t[0]),t.remove(),o()):t.addClass(a):t.hasClass(a)&&t.removeClass(a)}function r(e){var t="A"===e.tagName?e.parentNode:e;text=t.textContent||t.innerText,text=text.slice(0,-1),b.splice(b.indexOf(text),1)}function c(e){C.style.width=(e||10)+"px"}function u(t){var a=t?t.toLowerCase():e.trim(C.value.toLowerCase()),l=e.inArray(a.toLowerCase(),b),o=w.find(".taggle_list");return n.duplicateTagClass&&o.find("."+n.duplicateTagClass).length&&o.find("."+n.duplicateTagClass).removeClass(n.duplicateTagClass),l>-1?(o.children()[l].className+=" "+n.duplicateTagClass,!0):!1}function d(e){var t=e.keyCode,a=!1;return(188===t||9===t||13===t)&&(a=!0),a}function h(){o(),w.hasClass(n.containerFocusClass)||w.addClass(n.containerFocusClass),n.placeholder&&L.fadeOut("fast")}function f(){C.value="",c(),w.hasClass(n.containerFocusClass)&&w.removeClass(n.containerFocusClass),!b.length&&n.placeholder&&L.fadeIn("fast")}function p(e){e=e||window.event,v(),d(e)&&""!==C.value&&g(e),s(e)}function m(e){e=e||window.event}function g(e){e=e||window.event;var t,a=e.keyCode;return w.find(".taggle:last"),(9===a||13===a)&&(t=u()),(!t||n.allowDuplicates)&&i(),e.preventDefault(),!1}function v(){var e=4.5*(n.fontSize/8)*C.value.length,t=w.outerWidth()-w.width(),a=w.outerWidth()-t;e+5>parseInt(C.style.width,10)&&(C.style.width=a+"px")}function S(t){t=t||window.event;var a=e(t.target).parent("li");a.remove(),h(),r(t.target)}var w=e(this),b=[],y=document.createElement("ul"),k=document.createElement("li"),C=document.createElement("input"),L=e("<span>");t()})}})(jQuery);